{{> auth-head}}

<!-- reCAPTCHA v3 - will load key from environment on init -->
<script src="https://www.google.com/recaptcha/api.js?render=explicit" async defer></script>

<div class="auth-container">
  <h1 class="title">
    <a href="/" class="logo-link">
      <span class="fit">Fit</span><span class="glue">Glue</span>
    </a>
  </h1>
  <h2>Create Your Account</h2>
  <p class="auth-subtitle">Start your 30-day free Athlete trial ðŸš€</p>

  <div class="auth-box">
    <div id="auth-error" class="auth-message error" style="display: none;"></div>
    <div id="auth-success" class="auth-message success" style="display: none;"></div>

    <div class="input-group">
      <input type="text" id="reg-name" placeholder="Your Name" autocomplete="name" />
    </div>
    <div class="input-group">
      <input type="email" id="reg-email" placeholder="Email" />
    </div>
    <div class="input-group">
      <input type="password" id="reg-password" placeholder="Password (min 6 chars)" />
    </div>
    <button id="btn-register" class="btn primary">
      <span class="btn-text">Create Account</span>
      <span class="btn-loading" style="display: none;">
        <span class="spinner"></span>
      </span>
    </button>

    <p class="terms-note">
      By signing up, you agree to our
      <a href="/terms" target="_blank">Terms of Service</a>
    </p>

    <p class="switch-auth">
      Already have an account? <a href="/auth/login">Login</a>
    </p>
  </div>
</div>

<style>
  .auth-subtitle {
    color: var(--color-text-muted, #AAA);
    font-size: 1rem;
    margin: -0.5rem 0 1.5rem;
    text-align: center;
  }

  .terms-note {
    font-size: 0.8rem;
    color: var(--color-text-muted, #AAA);
    text-align: center;
    margin-top: 1rem;
  }

  .terms-note a {
    color: var(--color-primary);
  }

  .btn-loading {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .btn.loading .btn-text {
    display: none;
  }

  .btn.loading .btn-loading {
    display: inline-flex;
  }
</style>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, createUserWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  const errorEl = document.getElementById('auth-error');
  const successEl = document.getElementById('auth-success');
  const registerBtn = document.getElementById('btn-register');

  let recaptchaSiteKey = null;
  let recaptchaReady = false;

  function showError(message) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    successEl.style.display = 'none';
  }

  function hideError() {
    errorEl.style.display = 'none';
  }

  function showSuccess(message) {
    successEl.textContent = message;
    successEl.style.display = 'block';
    errorEl.style.display = 'none';
  }

  function setLoading(loading) {
    if (loading) {
      registerBtn.classList.add('loading');
      registerBtn.disabled = true;
    } else {
      registerBtn.classList.remove('loading');
      registerBtn.disabled = false;
    }
  }

  async function getFirebaseConfig() {
    try {
      const response = await fetch('/__/firebase/init.json');
      if (response.ok) {
        return await response.json();
      }
    } catch (e) {
      console.warn('Could not load Firebase config:', e);
    }
    return null;
  }

  async function getRecaptchaSiteKey() {
    try {
      // Fetch reCAPTCHA site key from our config endpoint
      const response = await fetch('/api/config/recaptcha');
      if (response.ok) {
        const data = await response.json();
        return data.siteKey;
      }
    } catch (e) {
      console.warn('Could not load reCAPTCHA config:', e);
    }
    return null;
  }

  async function executeRecaptcha(action) {
    if (!recaptchaReady || !recaptchaSiteKey) {
      console.warn('reCAPTCHA not ready, proceeding without token');
      return null;
    }
    try {
      return await grecaptcha.execute(recaptchaSiteKey, { action });
    } catch (e) {
      console.error('reCAPTCHA execution failed:', e);
      return null;
    }
  }

  async function init() {
    const firebaseConfig = await getFirebaseConfig();
    if (!firebaseConfig) {
      showError('Could not initialize authentication. Please try again later.');
      return;
    }

    // Initialize reCAPTCHA
    recaptchaSiteKey = await getRecaptchaSiteKey();
    if (recaptchaSiteKey && typeof grecaptcha !== 'undefined') {
      grecaptcha.ready(() => {
        recaptchaReady = true;
        console.log('reCAPTCHA v3 ready');
      });
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    registerBtn.addEventListener('click', async () => {
      hideError();
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password').value;

      // Validation
      if (!name) {
        showError('Please enter your name');
        return;
      }
      if (!email) {
        showError('Please enter your email');
        return;
      }
      if (password.length < 6) {
        showError('Password must be at least 6 characters');
        return;
      }

      setLoading(true);

      try {
        // Execute reCAPTCHA (if available)
        const recaptchaToken = await executeRecaptcha('register');

        // Create Firebase user
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);

        // Set display name
        await updateProfile(userCredential.user, { displayName: name });

        // Send verification email via our custom branded handler
        try {
          const idToken = await userCredential.user.getIdToken();
          await fetch('/api/auth-email/send-verification', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${idToken}`,
            },
          });
        } catch (emailError) {
          console.warn('Failed to send verification email:', emailError);
          // Don't block registration if email fails â€” they can resend later
        }

        // Redirect to waitlist confirmation page
        window.location.href = '/auth/waitlist-confirmed';
      } catch (error) {
        setLoading(false);
        // Friendly error messages
        if (error.code === 'auth/email-already-in-use') {
          showError('This email is already registered. Try logging in instead.');
        } else if (error.code === 'auth/weak-password') {
          showError('Password is too weak. Please use at least 6 characters.');
        } else if (error.code === 'auth/invalid-email') {
          showError('Please enter a valid email address.');
        } else {
          showError(error.message);
        }
      }
    });

    // Allow enter key to submit
    document.getElementById('reg-password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        registerBtn.click();
      }
    });
  }

  init();
</script>

{{> auth-footer}}